# データソース仕様 v4（JRA公式レース結果ページ基盤）

本ドキュメントでは、競馬予測モデル用データベース（v4 スキーマ）で使用する
**データソース** および **ID ポリシー** を定義する。

目的は以下の 2 点：

- **JRA公式レース結果ページのみを一次ソースとして自動 ETL を完結させること**
- データ取得ロジックを “再現性のある形式” に統一し、後からデータを追加しても崩れない構造にすること

---

# 1. データソース概要

本システムで使用する一次ソースは **JRA公式サイト（無料 / ログイン不要）** のみ。

### ■ メインデータソース（必須）

| 用途 | データソース | URL例 |
|------|--------------|-------|
| レース情報 | JRA レース結果ページ | https://www.jra.go.jp/…（公式URL構造） |
| 馬・騎手・調教師 ID | レース結果ページ内のプロフィールリンク | （例：/datafile/horse/012345.html） |
| オッズ・人気 | 結果ページ内の「単勝」欄 | 別ページ取得は不要 |
| 上がり / タイム | 着順表に直接記載 | - |

> **v4 の重要方針：**  
> *別ページ（オッズページ等）への追加取得は行わない。  
> すべて「結果ページ（1枚）」から抽出できる範囲に限定する。*

---

# 2. ID ポリシー（v4 仕様）

データの再現性確保のため、ID はすべて **“JRA公式URL由来のID”** を採用する。

## 2.1 race_id（JRA公式ID）

URLに含まれる 12 桁のコードをそのまま採用。

例：
202405020411

- YYYY + 開催 + 日 + レース番号
- 完全一意で再取得が容易

## 2.2 horse_id（JRAの馬プロフィールURLから抽出）

例：


/datafile/horse/012345.html → 012345


## 2.3 jockey_id（JRA騎手ページURLから抽出）

例：


/datafile/jockey/01085.html → 01085


## 2.4 trainer_id（JRA調教師ページURLから抽出）

例：


/datafile/trainer/01123.html → 01123


## 2.5 course_id（手動定義）

コースはHTMLから自動抽出しにくいため、**手動マスタ** として扱う。

例：


TOK_T_OUT
HAN_D_IN


---

# 3. テーブル別：取得元

## 3.1 courses（手動・静的マスタ）

| カラム | 取得元 |
|--------|--------|
| course_id | 手動定義 |
| venue_id | 手動 |
| surface | 手動 |
| track_type | 手動 |
| straight_len / slope_max | JRAコース図から手動入力 |

## 3.2 races（JRA結果ページ）

- 距離
- コース（芝/ダート）
- 天候
- 馬場状態（良/稍重/重/不良）
- レース名
- クラス、年齢条件、性別条件
- 出走頭数  
など

## 3.3 race_results（JRA結果ページ）

- 枠番 / 馬番
- 馬名
- 騎手・調教師（URLからID抽出）
- タイム / 上がり3F
- 着差
- 単勝オッズ / 人気
- 馬体重
- コーナー通過順位  
など

## 3.4 horses / jockeys / trainers（JRA結果ページ）

リンクURLから ID を抽出し、名前を保存する。

---

# 4. 生HTML保存ポリシー

スクレイピング再実行を避けるため、必ず HTML を保存する。



data/raw/jra/race_<race_id>.html


メリット：
- HTML構造変化に強い
- ETL失敗時に Transform 部分だけ修正すれば良い
- 再学習用のデータセット整理が容易

---

# 5. データ利用に関する注意

- JRA公式サイトは無料利用可能だが、連続大量アクセスは避ける  
  → HTMLはローカル保存し、再取得しない運用にする
- netkeiba は利用制限が厳しいため **使用禁止**  
  → 必要なデータは race_results を集計して自前で算出

---

# 6. 今後の追加データ（計画）

v4 スキーマは「生データのみ」を保存し、  
統計値や特徴量は以下のテーブルで後付けする方針：

- horses_stats（通算成績）
- jockeys_stats
- trainers_stats

---

# 7. まとめ

- **一次ソースは JRA結果ページ（1ページのみ）に統一**
- **ID は JRA公式リンクから抽出**
- **courses のみ手動マスタ**
- **生HTML保存は必須**
- v4 は「完全自動 ETL」を前提にし、外部ソースに依存しない構造を目指す